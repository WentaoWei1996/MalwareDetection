package com.xidian.malwaredetection.web.controller;

import com.alibaba.fastjson.JSONObject;
import com.xidian.malwaredetection.model.Msg;
import com.xidian.malwaredetection.service.DetectService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.*;

/**
 * @author wwt
 * @date 2019/8/22 9:24
 */

@Controller
public class DetectController {

    @Autowired
    DetectService detectService;

    @RequestMapping(value = "/detect", method = RequestMethod.POST)
    @ResponseBody
    public Msg detect(HttpServletRequest request){
        JSONObject jsonObject = null;
        try {
            BufferedReader streamReader = new BufferedReader( new InputStreamReader(request.getInputStream(), "UTF-8"));
            StringBuilder responseStrBuilder = new StringBuilder();
            String inputStr;
            while ((inputStr = streamReader.readLine()) != null) {
                responseStrBuilder.append(inputStr);
            }
            jsonObject = JSONObject.parseObject(responseStrBuilder.toString());
        } catch (Exception e) {
            e.printStackTrace();
        }

        Map<String,Double> map = new LinkedHashMap<>();

        if (jsonObject!=null){
            JSONObject json = jsonObject.getObject("extend", JSONObject.class);
            for (Map.Entry<String,Object> entry : json.entrySet()){
                map.put(entry.getKey(),Double.parseDouble(entry.getValue().toString()));
            }
        }

//        System.out.println(jsonObject.toString());
//        System.out.println(map);
//        Map<String,Double> map1 = new HashMap<String, Double>();
//        map1.put("667626 905613 1023396 26946 800999 1060886 442098 61636 889269 711476",1.0);
//        map1.put("817968 1219598 350978 830330 326598 415482 542555 764482 252251 350335",1.0);
//        System.out.println(map1);

        return Msg.sussess().add("result",detectService.detect(map));
    }

    /*public static void main(String[] args) {
        SpringApplication.run(DetectController.class,args);
    }*/
}
